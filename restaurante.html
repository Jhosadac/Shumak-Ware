<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante - Shumak Ware</title>
    <!--estilos-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Caveat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <!--importando firebase-->
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
</head>
<body>
    <div class="rest-header">
	<div class="logo">
		<img src="assests/logo_final.png">
	</div>
	<div class="rest-nav">
		<a href="index.html">Inicio</a>
		<a href="restaurante.html">Restaurante</a>
		<a href="servicios.html">Servicio</a>
		<a href="contacto.html">Contacto</a>
		<a href="habitaciones.html">Habitaciones</a>
	</div>  
    </div>
    <div class="rest-options">
	    <div class="rest-logo-label">Shumak Ware</div>
	    <div class="rest-menu">Menu</div>
	    <div class="rest-reservas">Reservas</div>
	    <div class="rest-call-container">
		    <div class="rest-call-upper">Llamanos</div>
		    <div class="rest-call-number">(0700) 123 456</div>
	    </div>
    </div>

    <!--categorias-->
    <div class="platos-header">
	<div class="platos-header-title">Nuestra Gastronomia</div>
	<div class="platos-header-description">
		La gastronomía ancashina, tesoro culinario de los Andes peruanos, fusiona la riqueza de su costa y sierra. 
		Se destaca por el uso intensivo de ingredientes autóctonos como la papa, el maíz, el ají y carnes como el cuy y el chancho. 
		Platos emblemáticos como el picante de cuy, la patasca y la humita expresan su sabor único y ancestral.
	</div>
    </div>

    <div class="categorias-container">
	<!---Entradas-->
	<div class="categoria-container">
	    <div class="categoria-content">
		   papa huacaina ..................................... S/. 5 <br>
		    papa huacaina ..................................... S/. 5 <br>
		    papa huacaina ..................................... S/. 5 <br>
		    papa huacaina ..................................... S/. 5 <br>
		    papa huacaina ..................................... S/. 5 <br>
	    </div>
	    <div class="categoria-title">
		Entradas
	    </div>
	    <div class="categoria-images">
		<img src="assests/entradas_imagen.png">
	    </div>
	</div>

	<!---Sopas-->
	<div class="categoria-container">
	    <div class="categoria-content">
		    caldo de gallina ..................................... S/. 10 <br>
		    caldo de gallina ..................................... S/. 10 <br>
		    caldo de gallina ..................................... S/. 10 <br>
		    caldo de gallina ..................................... S/. 10 <br>
		    caldo de gallina ..................................... S/. 10 <br>
	    </div>
	    <div class="categoria-title">
		Sopas
	    </div>
	    <div class="categoria-images">
		<img src="assests/sopas_imagen.png">
	    </div>
	</div>

	<!---Segundos-->
	<div class="categoria-container">
	    <div class="categoria-content">
		  picante de cuy ..................................... S/. 15 <br>
		     picante de cuy ..................................... S/. 15 <br> 
		     picante de cuy ..................................... S/. 15 <br> 
		     picante de cuy ..................................... S/. 15 <br> 
		     picante de cuy ..................................... S/. 15 <br> 
	    </div>
	    <div class="categoria-title">
		Segundos
	    </div>
	    <div class="categoria-images">
		<img src="assests/segundos_imagen.png">
	    </div>
	</div>

	<!---Bebidas-->
	<div class="categoria-container">
	    <div class="categoria-content">
		     chicha morada (1L)..................................... S/. 9 <br>
		    chicha morada (1L)..................................... S/. 9 <br> 
		    chicha morada (1L)..................................... S/. 9 <br> 
		    chicha morada (1L)..................................... S/. 9 <br> 
		    chicha morada (1L)..................................... S/. 9 <br> 
	    </div>
	    <div class="categoria-title">
		Bebidas
	    </div>
	    <div class="categoria-images">
		<img src="assests/bebidas_imagen.png">
	    </div>
	</div>
    </div>

    <!--reservas-->
    <div class="rest-container">
	<div class="rest-img">
		<img src="assests/reser_imagen.jpg">
	</div> 
	<div class="rest-formulario">
	     <form id="restForm">
                <div class="form-group-rest">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div class="form-group-rest">
                    <label for="correo">Correo:</label>
                    <input type="email" id="correo" name="correo" required>
                </div>
                <div class="form-group-rest">
                    <label for="telefono">Teléfono:</label>
                    <input type="tel" id="telefono" name="telefono" required>
                </div>
                <div class="form-group-rest">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" name="fecha" required min="">
                </div>
                <div class="form-group-rest">
                    <label for="hora">Hora:</label>
                    <input type="time" id="hora" name="hora" required>
                </div>
                <div class="form-group-rest">
                    <label for="personas">Número de personas:</label>
                    <input type="number" id="personas" name="personas" min="1" max="40" required>
                </div>
                <button type="submit" id="enviarReserva">Reservar</button>
            </form>
	</div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal-hab" id="confirmationModal">
        <div class="modal-hab-content">
            <div class="confirmation">
                <i class="fas fa-check-circle"></i>
                <h2>¡Reserva Confirmada!</h2>
                <p>Tu reserva ha sido registrada exitosamente.</p>
                <p>ID de reserva: <strong id="reservationId">RES-2023-001</strong></p>
                <p>Por favor tome captura de su numero de reserva.</p>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>Acerca de Nosotros</h3>
                    <p>Shumak Ware es un hotel-restaurante campestre que combina la naturaleza con la comodidad</p>
                </div>
                <div class="footer-section">
                    <h3>Enlaces Rápidos</h3>
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="habitaciones.html">Habitaciones</a></li>
                        <li><a href="restaurante.html">Restaurante</a></li>
                        <li><a href="servicios.html">Servicios</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contacto</h3>
                    <ul>
                        <li><i class="fas fa-phone"></i> +51 912 345 678</li>
                        <li><i class="fas fa-envelope"></i> shumakware@gmail.com</li>
                        <li><i class="fas fa-map-marker-alt"></i> Anta, Huaraz, Ancash</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                &copy; 2023 Shumak Ware. Todos los derechos reservados.
            </div>
        </div>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyApq_K7pJmtrLNZcewzxaVXWnVf4Sxynv4",
            authDomain: "shumak-ware.firebaseapp.com",
            databaseURL: "https://shumak-ware-default-rtdb.firebaseio.com",
            projectId: "shumak-ware",
            storageBucket: "shumak-ware.firebasestorage.app",
            messagingSenderId: "64196160181",
            appId: "1:64196160181:web:76852cef50c12a498e6cfc",
            measurementId: "G-8L85H7B12E"
        };

        //Inicializar firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales
        let ubicacionIngresada = false;
        let carrito = [];
        let metodoEntrega = 'delivery';
         let reservationId = "";
        
        // Referencias a elementos del DOM
        const ubicacionInput = document.getElementById('ubicacionInput');
        const confirmarUbicacionBtn = document.getElementById('confirmarUbicacion');
        const pedirBtn = document.getElementById('pedirBtn');
        const minusBtns = document.querySelectorAll('.quantity-btn.minus');
        const plusBtns = document.querySelectorAll('.quantity-btn.plus');
        const addToCartBtns = document.querySelectorAll('.add-to-cart');
        const reservasBtn = document.getElementById('reservasBtn');
        const reservasModal = document.getElementById('reservasModal');
        const pedidoModal = document.getElementById('pedidoModal');
        const closeBtns = document.querySelectorAll('.close');
        const reservaForm = document.getElementById('reservaForm');
        const direccionPedido = document.getElementById('direccionPedido');
        const resumenCarrito = document.getElementById('resumenCarrito');
        const totalArticulos = document.getElementById('totalArticulos');
        const totalPedido = document.getElementById('totalPedido');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const deliveryOption = document.getElementById('deliveryOption');
        const recojoOption = document.getElementById('recojoOption');
        const confirmarPedidoBtn = document.getElementById('confirmarPedido');
        const nombrePedidoInput = document.getElementById('nombrePedido');
        const telefonoPedidoInput = document.getElementById('telefonoPedido');
        const confirmationModal = document.getElementById('confirmationModal');
        const reservationIdEl = document.getElementById('reservationId');
        
        // Establecer fecha mínima como hoy
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').min = today;
        
        // Confirmar ubicación
        confirmarUbicacionBtn.addEventListener('click', () => {
            if (ubicacionInput.value.trim() === '') {
                alert('Por favor ingresa una ubicación válida');
                return;
            }
            
            ubicacionIngresada = true;
            pedirBtn.classList.remove('disabled');
            
            // Habilitar controles de cantidad
            minusBtns.forEach(btn => btn.disabled = false);
            plusBtns.forEach(btn => btn.disabled = false);
            addToCartBtns.forEach(btn => btn.disabled = false);
            
            alert(`Ubicación confirmada: ${ubicacionInput.value}`);
        });
        
        // Función para manejar el carrusel
        function setupSlider(slidesContainerId) {
            const slidesContainer = document.getElementById(slidesContainerId);
            const slides = slidesContainer.querySelectorAll('.category-slide');
            const prevBtn = slidesContainer.parentElement.querySelector('.prev-btn');
            const nextBtn = slidesContainer.parentElement.querySelector('.next-btn');
            
            let currentIndex = 0;
            const slideCount = slides.length;
            
            function updateSlider() {
                slidesContainer.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
            
            prevBtn.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + slideCount) % slideCount;
                updateSlider();
            });
            
            nextBtn.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % slideCount;
                updateSlider();
            });
        }
        
        // Inicializar carruseles
        setupSlider('entradasSlides');
        setupSlider('sopasSlides');
        setupSlider('segundosSlides');
        setupSlider('bebidasSlides');
        
        // Manejar controles de cantidad
        document.querySelectorAll('.quantity-controls').forEach(control => {
            const minusBtn = control.querySelector('.minus');
            const plusBtn = control.querySelector('.plus');
            const quantityValue = control.querySelector('.quantity-value');
            
            minusBtn.addEventListener('click', () => {
                let value = parseInt(quantityValue.textContent);
                if (value > 0) {
                    value--;
                    quantityValue.textContent = value;
                }
            });
            
            plusBtn.addEventListener('click', () => {
                let value = parseInt(quantityValue.textContent);
                value++;
                quantityValue.textContent = value;
            });
        });
        
        // Manejar añadir al carrito
        addToCartBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const slide = this.closest('.category-slide');
                const title = slide.querySelector('.slide-title-rest').textContent;
                const priceText = slide.querySelector('.slide-price-rest').textContent;
                const price = parseFloat(priceText.replace('S/ ', ''));
                const quantity = parseInt(slide.querySelector('.quantity-value').textContent);
                const category = slide.closest('.container').querySelector('.underline').textContent.toLowerCase();
                if (quantity === 0) {
                    alert('Por favor selecciona al menos un ítem');
                    return;
                }
                
                // Buscar si el producto ya está en el carrito
                const productoExistente = carrito.find(item => item.nombre === title);
                
                if (productoExistente) {
                    // Actualizar cantidad
                    productoExistente.cantidad += quantity;
                } else {
                    // Añadir nuevo producto al carrito
                    carrito.push({
                        nombre: title,
                        precio: price,
                        cantidad: quantity,
                        categoria: category 
                    });
                }
                
                alert(`Añadido al carrito: ${quantity} x ${title} - ${priceText}`);
                slide.querySelector('.quantity-value').textContent = '0';
                
                // Actualizar contador de carrito
                actualizarContadorCarrito();
            });
        });
        
        // Actualizar contador de artículos en carrito
        function actualizarContadorCarrito() {
            const totalItems = carrito.reduce((total, item) => total + item.cantidad, 0);
            totalArticulos.textContent = totalItems;
        }
        
        // Abrir modal de reservas
        reservasBtn.addEventListener('click', function(e) {
            e.preventDefault();
            reservasModal.style.display = 'block';
        });
        
        // Abrir modal de pedido
        pedirBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (!ubicacionIngresada) {
                alert('Por favor confirma tu ubicación antes de realizar un pedido');
                return;
            }
            // Validar que haya productos en el carrito
            if (carrito.length === 0) {
                alert('No has seleccionado ningún producto. Por favor, añade productos a tu carrito antes de continuar.');
                return;
            }
            
            // Actualizar dirección en el modal
            direccionPedido.textContent = ubicacionInput.value;
            
            // Actualizar resumen de carrito
            actualizarResumenCarrito();
            
            // Mostrar modal
            pedidoModal.style.display = 'block';
        });
        
        // Cerrar modales
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                reservasModal.style.display = 'none';
                pedidoModal.style.display = 'none';
            });
        });
        
        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function(e) {
            if (e.target === reservasModal) {
                reservasModal.style.display = 'none';
            }
            if (e.target === pedidoModal) {
                pedidoModal.style.display = 'none';
            }
            if (e.target === confirmationModal) {
                confirmationModal.classList.remove('show');
            }
        });
        
        // Actualizar resumen de carrito
        function actualizarResumenCarrito() {
            resumenCarrito.innerHTML = '';
            
            if (carrito.length === 0) {
                emptyCartMessage.style.display = 'block';
                totalPedido.textContent = 'S/ 0.00';
                return;
            }
            
            emptyCartMessage.style.display = 'none';
            
            let total = 0;
            
            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'resumen-item';
                itemElement.innerHTML = `
                    <div>
                        <div>${item.nombre}</div>
                        <div style="font-size: 0.9rem; color: #666;">${item.cantidad} x S/ ${item.precio.toFixed(2)}</div>
                    </div>
                    <div>S/ ${subtotal.toFixed(2)}</div>
                `;
                
                resumenCarrito.appendChild(itemElement);
            });
            
            totalPedido.textContent = `S/ ${total.toFixed(2)}`;
        }
        
        // Seleccionar método de entrega
        deliveryOption.addEventListener('click', function() {
            deliveryOption.classList.add('selected');
            recojoOption.classList.remove('selected');
            metodoEntrega = 'delivery';
        });
        
        recojoOption.addEventListener('click', function() {
            recojoOption.classList.add('selected');
            deliveryOption.classList.remove('selected');
            metodoEntrega = 'recojo';
        });
        
        // Seleccionar delivery por defecto
        deliveryOption.classList.add('selected');

        // Generar código aleatorio de 10 dígitos
        function generarCodigo() {
            return "PED" + Math.floor(1000000000 + Math.random() * 9000000000).toString();
        }
        
        // Confirmar pedido
        confirmarPedidoBtn.addEventListener('click', function() {
            
            // Validar nombre y teléfono
            const nombre = nombrePedidoInput.value.trim();
            const telefono = telefonoPedidoInput.value.trim();
            
            if (!nombre || !telefono) {
                alert('Por favor, ingresa tu nombre y número de teléfono.');
                return;
            }
            
            // Obtener salsas seleccionadas
            const salsasSeleccionadas = Array.from(document.querySelectorAll('input[name="salsas"]:checked'))
                .map(input => input.value);

            // Agrupar productos por categoría
            const productosPorCategoria = {
                entradas: [],
                sopas: [],
                segundos: [],
                bebidas: []
            };

            carrito.forEach(item => {
                if (productosPorCategoria[item.categoria]) {
                    productosPorCategoria[item.categoria].push({
                        nombre: item.nombre,
                        precio: item.precio,
                        cantidad: item.cantidad
                    });
                }
            });

            // Obtener fecha y hora actual
            const fechaActual = new Date();
            const fecha = fechaActual.toISOString().split('T')[0];
            const hora = fechaActual.toTimeString().split(' ')[0].substring(0,5); // Formato HH:MM
            
            // Construir objeto pedido
            const pedido = {
                direccion: ubicacionInput.value,
                fecha: fecha,
                hora: hora,
                nombre: nombre,
                telefono: telefono,
                entradas: productosPorCategoria.entradas,
                sopas: productosPorCategoria.sopas,
                segundos: productosPorCategoria.segundos,
                bebidas: productosPorCategoria.bebidas,
                salsas: salsasSeleccionadas,
                metodoEntrega: metodoEntrega
            };
            
            // Generar código de pedido
            const codigoPedido = generarCodigo();
            
            // Enviar a Firebase
            const dbRef = database.ref('pedidos/' + codigoPedido);
            dbRef.set(pedido)
            .then(() => {
                alert('¡Pedido realizado con éxito! Tu código de pedido es: ' + codigoPedido);
            
            // Limpiar carrito
            carrito = [];
            actualizarContadorCarrito();
            
            // Cerrar modal
            pedidoModal.style.display = 'none';
        })    
        
        .catch(error => {
                console.error('Error al guardar el pedido:', error);
                alert('Hubo un error al procesar tu pedido. Por favor, intenta de nuevo.');
            });
        });

        //manejo de reservas
	async function confirmarReserva(clienteActual,codigoReserva){
    
    	try {
    	const refReservas = database.ref('reservas');
        const snapshot = await refReservas.once('value');
        const reservas = snapshot.val();
            
        const hoy = new Date();
        const entradaCliente = new Date(`${clienteActual.fecha}T${clienteActual.hora}:00-05:00`);
        const salidaCliente = new Date(entradaCliente.getTime() + 30 * 60000);
        if (entradaCliente < hoy) {
        	alert("No se puede reservar en una fecha pasada");
            return false;
        }
        
        let mesasOcupadas = 0;
	const totalMesas = 10;
        if (reservas) {
        	for(const key in reservas) {
                const reserva = reservas[key];
                const entradaExistente = new Date(`${reserva.fecha}T${reserva.hora}:00-05:00`);
                const salidaExistente = new Date(entradaExistente.getTime() + 30 * 60000);
            	if (reserva.fecha === clienteActual.fecha) {
                	if(salidaCliente > entradaExistente && entradaCliente < salidaExistente){
				mesasOcupadas += Math.ceil(reserva.personas / 4);
                    };
                }
                
            } 			
        }

	const mesasDisponibles = totalMesas - mesasOcupadas;
        const mesasRequeridas = Math.ceil(clienteActual.personas/4);
        if (mesasDisponibles < mesasRequeridas){
        	alert(`Mesas insuficientes. Disponibles: ${mesasDisponibles}, Requeridas: ${mesasRequeridas}`);
            return false;
        }

        await refReservas.child(codigoReserva).set(clienteActual);
       return true;
       } catch (error) {
       		alert(`Lo sentimos hubo un error al cargar sus datos. Error: ${error}`);
            return false;
       }
    }
   
reservaForm.addEventListener('submit', async function(e){
	e.preventDefault();
        	// Obtener datos del formulario
        const nombre = document.getElementById('nombre').value;
        const correo = document.getElementById('correo').value;
        const telefono = document.getElementById('telefono').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const personas = parseInt(document.getElementById('personas').value);
        
         // Validar campos
        if (!nombre || !correo || !telefono || !fecha || !hora || !personas) {
            alert('Por favor completa todos los campos');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(correo)) {
            alert("Por favor, introduce un correo electrónico válido.");
            return;
        }
    	
         // Validar número de personas
        if (personas < 1 || personas > 40) {
            alert('Por favor ingresa un número válido de personas (1-40)');
            return;
        }
        
        const clienteData = {
            nombre,
            correo,
            telefono,
            fecha,
            hora,
            personas,
        };
        codigoReserva = "REM" + Math.floor(1000000000 + Math.random() * 9000000000).toString();

        try {
        const reservaExitosa = await confirmarReserva(clienteData,codigoReserva);
        if (reservaExitosa) {
        	// Actualizar modal de confirmación
            reservationIdEl.textContent = codigoReserva;
    
            reservasModal.style.display = 'none';
            confirmationModal.style.display = 'block';
            // Resetear formulario
            reservaForm.reset();
        }
            
        } catch (error) {
            alert(`Error: ${error}`);
        }
    });
            

    </script>
</body>
</html>
